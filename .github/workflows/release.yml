name: Release to CurseForge

on:
  push:
    tags:
      - "v*"

jobs:
  curseforge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: ver
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create zip
        run: |
          zip -r "HC_Risk_Tracker-${{ steps.ver.outputs.version }}.zip" HCRiskTracker
          
      - name: Upload to CurseForge
        env:
          CF_API_TOKEN: ${{ secrets.CURSEFORGE_API_TOKEN }}
          CF_PROJECT_ID: ${{ vars.CURSEFORGE_PROJECT_ID }}
        run: |
          curl -sS -X POST "https://api.curseforge.com/v1/mods/${CF_PROJECT_ID}/files" \
            -H "x-api-key: ${CF_API_TOKEN}" \
            -H "Accept: application/json" \
            -F "file=@HC_Risk_Tracker-${{ steps.ver.outputs.version }}.zip" \
            -F "metadata={
              \"changelog\": \"Automated release ${{ steps.ver.outputs.version }}\",
              \"changelogType\": \"markdown\",
              \"releaseType\": \"release\",
              \"gameVersions\": [11404]
            };type=application/json"
