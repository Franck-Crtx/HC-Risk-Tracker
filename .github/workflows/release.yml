name: Release to CurseForge

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug project id (safe)
        run: |
          echo "Tag: $GITHUB_REF_NAME"
          echo "CURSEFORGE_PROJECT_ID='${{ vars.CURSEFORGE_PROJECT_ID }}'"
          if [ -z "${{ vars.CURSEFORGE_PROJECT_ID }}" ]; then
            echo "ERROR: CURSEFORGE_PROJECT_ID is empty"
            exit 1
          fi
          if [ -z "${{ secrets.CURSEFORGE_API_TOKEN }}" ]; then
            echo "ERROR: CURSEFORGE_API_TOKEN is empty"
            exit 1
          fi
          echo "CURSEFORGE_API_TOKEN is present (not displayed)."

      - name: Package and upload to CurseForge
        uses: BigWigsMods/packager@v2
        env:
          CF_API_KEY: ${{ secrets.CURSEFORGE_API_TOKEN }}
          GITHUB_OAUTH: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: -p "${{ vars.CURSEFORGE_PROJECT_ID }}"